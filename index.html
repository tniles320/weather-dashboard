<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Weather Dashboard</title>
</head>
<body>
  <h1>Weather Dashboard</h1>

  <main>
    <div class="search-list">
        <label for="search-input">Search for a City</label>
        <div id="search-row">
          <input id="search-input" type="text" placeholder="Search..">
          <button id="search-button" type="submit"><i class="fa fa-search"></i></button>
        </div>
        <div id="city-list"></div>
    </div>

    <div id="weather-container">
      <div id="current-weather">
        <div id="current-city"></div>
        <div id="current-list"></div>
      </div>
      <div id="future-forecast">
          <h2>5-Day Forecast:</h2>
          <div id="future-weather"></div>
      </div>
    </div>
  </main>

<script>

    var currentDay = moment().format("(L)");
    var forecastOne = moment().add(1,"days").format().slice(0, 10) + " 21:00:00";
    var forecastTwo = moment().add(2,"days").format().slice(0, 10) + " 21:00:00";
    var forecastThree = moment().add(3,"days").format().slice(0, 10) + " 21:00:00";
    var forecastFour = moment().add(4,"days").format().slice(0, 10) + " 21:00:00";
    var forecastFive = moment().add(5,"days").format().slice(0, 10) + " 21:00:00";
    

    var cities = [];

    // sets local storage cities in an array and separates them into individual strings
    function resetLocalCities() {
        var oldList = localStorage.getItem("cities");
            if (localStorage.getItem("cities") === null) {
                return;
            } else {
                cities = oldList.split(",");
                addCities(cities);

            }
    }

    resetLocalCities();

    // pushes entered city to array and adds it to local storage
    function getLocalCities(cityName) {
        if($("#search-input").val() === "") {
                return;
            } else {
                $("#city-list").html("");
                cities.push(cityName);
                localStorage.setItem("cities", cities);
            }
    }

    // function to add buttons to city list
    function addCities(cities) {
        for(var i = 0; i < cities.length; i++) {

            var newButton = $("<button>");
            newButton.addClass("cities");
            newButton.attr("value", cities[i]);
            newButton.text(cities[i]);
            $("#city-list").prepend(newButton);
        }

    }

    function inputFunction() {

        var cityName = $("#search-input").val().trim();

        getLocalCities(cityName);

        getCityInfo(cityName);

        // sets a max number for the array length
        if(cities.length > 10) {
            cities.shift();
            localStorage.setItem("cities", cities);
            addCities(cities);
        } else {
            addCities(cities);
        }
        // location.reload();
        $("#search-input").val("");
    }

    // search button on click event
    // click event prevents city button click event from working, only works if page is reloaded
    $("#search-button").on("click", function() {
        inputFunction();
    })

    $("#search-input").on("keypress", function(event) {
        if(event.which === 13) {
            event.preventDefault();
            inputFunction();
        }
    })

    // click event that displays weather info
    $(".cities").on("click", function() {

        var cityName = $(this).attr("value");
        getCityInfo(cityName);
    })

    // displays weather info
    function getCityInfo(cityName) {
        $("#current-city").html("");
        $("#current-list").html("");
        $("#future-weather").html("");
        
        // current day weather
        var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + cityName + "&appid=21ffb69761330cb50c25f45c59fb7cb9";

        $.ajax({
        url: queryURL,
        method: "GET"
        })

        .then(function(response) {

            var city = response.name;
            
            var icon = "https://openweathermap.org/img/wn/" + response.weather[0].icon + "@2x.png";
            var newImage = $("<img>")

            newImage.attr("src", icon);
            newImage.addClass("weather-icon");

            var newHead = $("<h2>")

            newHead.text(response.name + " " + currentDay);
            var oldHead = response.name + " " + currentDay;
            
            $("#current-city").append(newHead);
            $("#current-city").append(newImage);

            var temp = (response.main.temp - 273.15) * 9/5 + 32;
            var humidity = response.main.humidity;
            var windSpeed = response.wind.speed * 2.237;

            var lat = response.coord.lat;
            var lon = response.coord.lon;

            var getUV = "https://api.openweathermap.org/data/2.5/uvi?appid=21ffb69761330cb50c25f45c59fb7cb9&lat=" + lat + "&lon=" + lon;

            $.ajax({
                url: getUV,
                method: "GET"
            })

            .then(function(response) {

                var uvIndex = response.value;

                var newDiv = $("<div>");
                var tempDisplay = "Temperature: " + temp.toFixed(2) + " °F";
                var humidityDisplay = "Humidity: " + humidity + "%";
                var windDisplay = "Wind Speed: " + windSpeed.toFixed(1) + " MPH";
                var uvDisplay = "UV Index: " + uvIndex;

                newDiv.html(tempDisplay + "<br>" + humidityDisplay + "<br>" + windDisplay + "<br>" + uvDisplay);

                $("#current-list").append(newDiv);
            })
        })

        // five day forecast
        var fiveURL = "https://api.openweathermap.org/data/2.5/forecast?q=" + cityName + "&appid=21ffb69761330cb50c25f45c59fb7cb9";

        $.ajax({
        url: fiveURL,
        method: "GET"
        })

        .then(function(response) {

            var forecastDayOne = moment().add(1,"days").format("L");
            var forecastDayTwo = moment().add(2,"days").format("L");
            var forecastDayThree = moment().add(3,"days").format("L");
            var forecastDayFour = moment().add(4,"days").format("L");
            var forecastDayFive = moment().add(5,"days").format("L");

            // function to display forecast info
            function displayForecast() {

                // appends container for days forecast
                var forecastDiv = $("<div>");
                forecastDiv.addClass("forecast-container");
                forecastDiv.addClass("" + j);
                $("#future-weather").append(forecastDiv);

                // appends div for date
                var forecastDay = $("<div>");
                forecastDay.addClass("forecast-day" + j);
                $("." +j).append(forecastDay);

                // appends weather icon
                var forecastImage = $("<img>")
                forecastImage.attr("src", forecastIcon);
                forecastImage.addClass("weather-icon");
                $("." + j).append(forecastImage);

                // appends temp and humidity
                var bottomDiv = $("<div>");
                var forecastTempDisplay = "Temp: " + forecastTemp.toFixed(2) + " °F";
                var forecastHumidityDisplay = "Humidity: " + forecastHumidity + "%";
                bottomDiv.html(forecastTempDisplay + "<br>" + forecastHumidityDisplay);
                $("." + j).append(bottomDiv);

            }

            // loop to find the 5 day forecast info
            for(var j = 0; j < response.list.length; j++) {

                var matchDay = response.list[j].dt_txt;
                var forecastTemp = (response.list[j].main.temp - 273.15) * 9/5 + 32;
                var forecastHumidity = response.list[j].main.humidity;
                var forecastIcon = "https://openweathermap.org/img/wn/" + response.list[j].weather[0].icon + "@2x.png";

                // adds content for each day based off of info at 3:00pm
                if(matchDay == forecastOne) {
                    displayForecast();
                    $(".forecast-day" + j).append(forecastDayOne);
                }
                if(matchDay == forecastTwo) {
                    displayForecast();
                    $(".forecast-day" + j).append(forecastDayTwo);
                }
                if(matchDay == forecastThree) {
                    displayForecast();
                    $(".forecast-day" + j).append(forecastDayThree);
                }
                if(matchDay == forecastFour) {
                    displayForecast();
                    $(".forecast-day" + j).append(forecastDayFour);
                }
                if(matchDay == forecastFive) {
                    displayForecast();
                    $(".forecast-day" + j).append(forecastDayFive);
                }
            }
        })
    }


</script>
</body>
</html>